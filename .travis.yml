language: node_js
node_js:
- '10'
services: docker
branches:
  except: "/^[0-9]/"
env:
  global:
  - TZ='Europe/Oslo'
  - RELEASE_VERSION="$(git fetch --unshallow || true && git rev-list --count $TRAVIS_COMMIT)"
  - DOCKER_IMAGE_FULL_NAME="$TRAVIS_REPO_SLUG:$RELEASE_VERSION"
  - GITHUB_APP_ID=26100
  - DOCKER_USERNAME=naviktdocker
  - secure: PDktaSsf4X4Zp7TYpMjsGMccFPdAxPMNuqYEnbaodep9OldoHeBo+oFyrhvxmKOJoxBwAZgBstkgEpPMMHdkrYGNrkMC/0uOepRNNgr0Dy2ASpXCzF3ShAcWQJoxxR06ZaxvXdt3F32mLPdK8jE/ccvuCA5IhtIDnNsgTTD9Qfcd+9ImYDKDTmMVssVHZ63kL8sZCE3uUER59kdVmV4b3CCqzcfrqBN1dC0Aw7rYi+Zj9jiyPpQIcwHA5785T+oI/CWE6EMtBAlztgtzHQ0wa+ol4SZcQT7SWJg24xK7yTeUa5yRK/JhjOLxXhnYeQm3Sya3CI++sEUJtjq/Tx93Usn/LF4MtFZiAK/d4bW6iHSMEb5Ng5sEbgqRktN/VUS/654dB7bzn2/2UdnKirCk2CO8b4CkdLXhVyTY5eoBX9AL8msCJXvkqk4deX1ufFepp4ktvBuSopXLhD62CwJw2FCLeInxscBCfmNQilQH995vWcQyh+HBe8DkPBD47RW5QxpjGrvgKlnJPPEVIHweWUTz/9dJ/HW5a3h/fcit/GthMOa+YYV11D74Bj1ioij97XqhVpYek1eTN//NtEaNaFdkjhSVfoHkJdbLerFErLHPJfPyFDR8uwBecN3w026+K0+XhwZtxX5E4vebsFFMRaRsj95J4CwXVNvUcieG4FE=
script:
- npm run build
- docker build -t "$DOCKER_IMAGE_FULL_NAME" .
deploy:
  provider: script
  script: docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" && docker push
    "$DOCKER_IMAGE_FULL_NAME"
  on:
    branch: master
after_deploy:
- git remote add auth-origin "https://x-access-token:${GH_TOKEN}@github.com/${TRAVIS_REPO_SLUG}"
- git tag $RELEASE_VERSION
- git push auth-origin --tags
before_install:
- openssl aes-256-cbc -K $encrypted_98dcabe19c4b_key -iv $encrypted_98dcabe19c4b_iv
  -in travis/datajegerne-private-key.enc -out travis/datajegerne-private-key.pem -d
- export GH_TOKEN=$(./travis/generate-installation-token.sh `./travis/generate-jwt.sh
  ./travis/datajegerne-private-key.pem $GITHUB_APP_ID`)
